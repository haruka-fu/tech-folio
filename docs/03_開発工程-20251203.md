# 開発工程 (2025-12-03)

## 概要

Supabase認証を統合し、マルチユーザー対応のポートフォリオアプリケーションを実装する。

## 最新の更新 (2025-12-03)

### セキュリティ強化

- **RLSポリシーの完全実装**
  - 全テーブル（profiles, projects, tags, roles, project_tags, auth_providers）に包括的なRLSポリシーを実装
  - ユーザーは自分のデータのみを編集可能、他のユーザーのデータは閲覧のみ
  - パフォーマンス最適化のためのインデックスを追加
  - 古い重複ポリシーをクリーンアップ
  - Supabaseアドバイザーによるセキュリティ検証完了

### データベース・API改善

- **表示名の一意性制約と重複チェック機能**
  - `profiles.display_name`にユニーク制約を追加（マイグレーション）
  - `profiles.user_id`の制約を修正（UUID対応、4〜100文字）
  - `user_id_change_count`カラムを削除（不要なため）
  - 表示名重複チェックAPI（`/api/profiles/check-display-name`）を実装
  - 登録時の表示名重複チェックを強化（データベースレベル）
  - ユニーク制約エラーのハンドリング改善

### UI/UX改善

- **新規プロジェクト追加ボタンのレスポンシブ対応**
  - 表示ブレークポイントを640pxから1200pxに変更
  - 1200px以上：ヘッダー内にボタン表示
  - 1200px未満：左下にフローティング＋アイコンボタン表示
  - より一貫性のあるUI体験を提供

## 実装状況サマリー

### ✅ 完了済み

- 認証機能（Google OAuth、セッション管理、デモモード）
- 新規ユーザー登録フロー（表示名の重複チェック、データ検証）
- プロジェクト管理（CRUD、フィルタリング、ソート、ページネーション）
- プロフィール管理（表示、編集、アバター画像、SNSリンク）
- Qiita連携（OAuth、記事取得、タイムライン統合）
- スキル統計（タグ集計、グラフ表示、工程統計）
- レスポンシブデザイン（デスクトップ・タブレット・モバイル対応）
- RLSポリシー（全テーブルに包括的なセキュリティポリシーを実装）

### 🔄 部分的に実装

- タグ管理（表示・選択は可能、CRUD UIは未実装）

### ❌ 未実装

- メール/パスワード認証
- プロフィール初期設定画面（統合）
- タグ管理UI（ユーザーによる作成・編集・削除）
- ダークモード
- 多言語対応

## 開発フェーズ

### Phase 1: Supabase認証の基盤構築 ✅

- [x] Supabase設定ファイルの作成
- [x] データベーススキーマの設計
- [x] Supabaseクライアントの設定
  - `lib/supabase/client.ts` - クライアント側
  - `lib/supabase/server.ts` - サーバー側（SSR対応）
- [x] 型定義の整備
  - `lib/types/auth.ts`
  - `lib/types/profile.ts`
  - `lib/types/project.ts`
  - `lib/types/qiita.ts`

### Phase 2: 認証機能の実装 ✅

- [x] ログイン画面の作成
  - [x] `app/login/page.tsx` の作成
  - [x] Google OAuth認証の実装
  - [x] 認証エラーハンドリング
  - [ ] メール/パスワード認証の実装（オプション・未実装）
- [x] 認証状態管理
  - [x] `lib/hooks/useAuth.ts` の作成
  - [x] セッション管理（クッキーベース）
  - [x] ルート保護の実装
- [x] デモモードの実装
  - [x] `lib/demo-data.ts` - デモデータ定義
  - [x] 未ログイン時のデモデータ表示
- [x] サインアップフロー（部分実装）
  - [x] 新規ユーザー登録画面（`app/register/page.tsx`）
  - [x] 表示名の重複チェック機能（データベースレベル）
  - [ ] プロフィール初期設定画面（統合予定）

### Phase 3: ルーティングとナビゲーションの構築 ✅

- [x] ルート構成の実装
  - [x] `/` → トップページ
  - [x] `/login` → ログイン画面
  - [x] `/projects` → プロジェクト一覧
  - [x] `/projects/new` → プロジェクト作成
  - [x] `/projects/[id]` → プロジェクト詳細
  - [x] `/projects/[id]/edit` → プロジェクト編集
  - [x] `/profile` → プロフィール表示
  - [x] `/profile/settings` → 設定画面
- [x] ナビゲーションの実装
  - [x] `app/_components/AppHeader.tsx` - 認証状態対応
  - [x] ログアウト機能の追加
  - [x] 未認証時のリダイレクト処理
  - [x] レスポンシブ対応（新規追加ボタンの表示切替：1200px基準）
- [x] フッターの実装
  - [x] `app/_components/AppFooter.tsx`

### Phase 4: プロジェクト管理機能 ✅

- [x] プロジェクトCRUD操作
  - [x] 作成: `app/projects/new/page.tsx`
  - [x] 読取: `app/projects/page.tsx`, `app/projects/[id]/page.tsx`
  - [x] 更新: `app/projects/[id]/edit/page.tsx`
  - [x] 削除: 削除確認モーダル付き
- [x] カスタムフック
  - [x] `lib/hooks/useProjectForm.ts` - フォームロジック共通化
- [x] プロジェクト一覧機能
  - [x] ログインユーザーのprofile_idでフィルタ
  - [x] タイムライン表示（プロジェクト + Qiita記事）
  - [x] タグフィルタ
  - [x] 工程フィルタ
  - [x] タブフィルタ（全て/プロジェクト/Qiita）
  - [x] 検索機能（タイトル、サマリー）
  - [x] 日付降順ソート
  - [x] 無限スクロールページネーション（20件/ページ）
- [x] プロジェクトコンポーネント
  - [x] `app/projects/_components/ProjectCard.tsx`
  - [x] `app/projects/_components/TimelineList.tsx`
  - [x] `app/projects/_components/SearchAndFilters.tsx`
  - [x] `app/projects/_components/TabFilter.tsx`
  - [x] `app/projects/_components/DeleteConfirmModal.tsx`
- [x] フォームコンポーネント
  - [x] `app/_components/modal/ProjectBasicFields.tsx`
  - [x] `app/_components/modal/DateRangeFields.tsx`
  - [x] `app/_components/modal/PhaseSelector.tsx`
  - [x] `app/_components/TagSelector.tsx`

### Phase 5: プロフィール管理機能 ✅

- [x] プロフィール表示
  - [x] `app/profile/page.tsx`
  - [x] `app/profile/_components/ProfileCard.tsx`
  - [x] ヘッダーのアバター画像表示
  - [x] プロフィール名の動的表示
- [x] プロフィール編集
  - [x] `app/profile/settings/page.tsx`
  - [x] `app/profile/settings/_components/BasicInfoForm.tsx`
  - [x] 表示名、自己紹介の編集
- [x] アバター画像管理
  - [x] `app/profile/settings/_components/AvatarUpload.tsx`
  - [x] Supabase Storageへのアップロード
  - [x] プレビュー機能
- [x] SNSリンク管理
  - [x] `app/profile/settings/_components/SNSLinksForm.tsx`
  - [x] Twitter、GitHub、Qiita、その他のURL設定

### Phase 6: スキル統計機能 ✅

- [x] タグ統計
  - [x] `lib/utils/stats.ts` - 統計計算ロジック
  - [x] タグ使用回数の集計
  - [x] トップ10表示
  - [x] `app/profile/_components/SkillStatsCard.tsx`
  - [x] 棒グラフ形式とグリッド形式の切り替え
- [x] 工程統計
  - [x] `app/profile/_components/RoleStatsCard.tsx`
  - [x] 担当工程の集計と表示

### Phase 7: Qiita連携機能 ✅

- [x] OAuth認証
  - [x] `app/api/qiita/auth/route.ts` - 認証開始
  - [x] `app/api/qiita/callback/route.ts` - コールバック処理
  - [x] CSRF対策（state検証）
- [x] 記事取得
  - [x] `app/api/qiita/articles/route.ts` - 記事一覧取得（最大100件）
  - [x] アクセストークンを使用したAPI呼び出し
- [x] タイムライン統合
  - [x] プロジェクトとQiita記事の統合表示
  - [x] `app/projects/_components/QiitaCard.tsx`
- [x] 連携管理
  - [x] `app/api/qiita/disconnect/route.ts` - 連携解除
  - [x] `app/profile/settings/_components/QiitaIntegration.tsx` - 設定UI

### Phase 8: データベースセキュリティ ✅

- [x] Row Level Security (RLS) の設定
  - [x] profilesテーブルのRLSポリシー（全ユーザー閲覧可能、所有者のみ編集）
  - [x] projectsテーブルのRLSポリシー（全ユーザー閲覧可能、所有者のみ編集）
  - [x] tagsテーブルのRLSポリシー（全ユーザー閲覧可能、認証ユーザー編集可能）
  - [x] rolesテーブルのRLSポリシー（全ユーザー閲覧専用）
  - [x] project_tagsテーブルのRLSポリシー（プロジェクト所有者のみ編集）
  - [x] auth_providersテーブルのRLSポリシー（所有者のみアクセス）
  - [x] 全テーブルのRLSポリシー検証完了
  - [x] パフォーマンス最適化（インデックス追加）
- [ ] 認証トリガーの設定（将来の改善項目）
  - [ ] 新規ユーザー作成時の自動プロフィール作成
  - [ ] デフォルトロールの割り当て

### Phase 9: UI/UX改善 ✅

- [x] レスポンシブデザイン
  - [x] Desktop-firstアプローチ
  - [x] ブレークポイント: 860px（tablet）、1200px（laptop）
  - [x] `app/globals.css` - カスタムアニメーション
- [x] モーダル/ダイアログ
  - [x] 削除確認モーダル
  - [x] ログインモーダル
- [x] アニメーション効果
  - [x] hover effects、slide-in、fade-in、scale
  - [x] btn-shimmer、btn-glow
- [ ] 追加のUI/UX改善（未実装）
  - [ ] ローディング状態の改善
  - [ ] トースト通知
  - [ ] オンボーディングツアー
  - [ ] ダークモード

## 実装済みファイル一覧

### コアライブラリ

- `lib/supabase/client.ts` - クライアントサイドSupabaseクライアント
- `lib/supabase/server.ts` - サーバーサイドSupabaseクライアント
- `lib/hooks/useAuth.ts` - 認証フック
- `lib/hooks/useProjectForm.ts` - プロジェクトフォームフック
- `lib/demo-data.ts` - デモデータ定義

### ユーティリティ

- `lib/utils/auth.ts` - 認証関連
- `lib/utils/format.ts` - フォーマット
- `lib/utils/stats.ts` - 統計計算
- `lib/utils/tags.ts` - タグ関連
- `lib/utils/url.ts` - URL操作

### 型定義

- `lib/types/auth.ts`
- `lib/types/profile.ts`
- `lib/types/project.ts`
- `lib/types/qiita.ts`

### ページ

- `app/page.tsx` - トップページ
- `app/login/page.tsx` - ログイン
- `app/register/page.tsx` - 新規ユーザー登録
- `app/projects/page.tsx` - プロジェクト一覧
- `app/projects/new/page.tsx` - プロジェクト作成
- `app/projects/[id]/page.tsx` - プロジェクト詳細
- `app/projects/[id]/edit/page.tsx` - プロジェクト編集
- `app/profile/page.tsx` - プロフィール
- `app/profile/settings/page.tsx` - 設定

### 共通コンポーネント

- `app/_components/AppHeader.tsx` - ヘッダー
- `app/_components/AppFooter.tsx` - フッター
- `app/_components/TagSelector.tsx` - タグ選択

### プロジェクトコンポーネント

- `app/projects/_components/ProjectCard.tsx`
- `app/projects/_components/QiitaCard.tsx`
- `app/projects/_components/TimelineList.tsx`
- `app/projects/_components/SearchAndFilters.tsx`
- `app/projects/_components/TabFilter.tsx`
- `app/projects/_components/PageHeader.tsx`
- `app/projects/_components/DemoModeBanner.tsx`
- `app/projects/_components/LoginModal.tsx`
- `app/projects/_components/DeleteConfirmModal.tsx`

### フォームコンポーネント

- `app/_components/modal/ProjectBasicFields.tsx`
- `app/_components/modal/DateRangeFields.tsx`
- `app/_components/modal/PhaseSelector.tsx`
- `app/_components/modal/FormActions.tsx`

### プロフィールコンポーネント

- `app/profile/_components/ProfileCard.tsx`
- `app/profile/_components/SkillStatsCard.tsx`
- `app/profile/_components/RoleStatsCard.tsx`
- `app/profile/settings/_components/BasicInfoForm.tsx`
- `app/profile/settings/_components/AvatarUpload.tsx`
- `app/profile/settings/_components/SNSLinksForm.tsx`
- `app/profile/settings/_components/QiitaIntegration.tsx`

### API Routes

- `app/api/profiles/check-display-name/route.ts` - 表示名重複チェック（サービスロール使用）
- `app/api/qiita/auth/route.ts` - Qiita認証開始
- `app/api/qiita/callback/route.ts` - Qiitaコールバック
- `app/api/qiita/articles/route.ts` - Qiita記事取得
- `app/api/qiita/disconnect/route.ts` - Qiita連携解除

## 必要な環境変数 (.env.local)

```env
NEXT_PUBLIC_SUPABASE_URL=your-project-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key  # 表示名重複チェックAPI用
```

## データベーステーブル構成

1. `profiles` - ユーザープロフィール情報（display_nameにユニーク制約）
2. `projects` - プロジェクト情報（profile_idで関連付け）
3. `tags` - 技術タグ
4. `roles` - 工程・役割
5. `project_tags` - プロジェクトとタグの中間テーブル
6. `auth_providers` - 認証プロバイダー情報（将来の拡張用）

### マイグレーション履歴

- `20251203000001_update_profiles_table.sql` - user_id_change_count削除、display_nameにユニーク制約追加
- `20251203000002_implement_rls_policies.sql` - 全テーブルにRLSポリシーを実装、パフォーマンスインデックス追加
- `20251203000003_cleanup_old_policies.sql` - 古い重複ポリシーをクリーンアップ

## 今後の開発タスク

### 優先度：高

1. **プロフィール初期設定画面の統合**
   - 登録フローと設定画面の統合
   - より洗練されたオンボーディング体験

2. **タグ管理UI**
   - ユーザーによるタグの作成・編集・削除
   - カテゴリとカラーの設定UI

3. **RLSポリシーの完全実装と検証**
   - 全テーブルのRLSポリシー検証
   - セキュリティテスト

### 優先度：中

4. **UI/UX改善**
   - トースト通知の実装
   - ローディング状態の改善
   - エラーメッセージの統一

5. **オンボーディング**
   - 初回ログイン時のツアー
   - ヘルプ機能

### 優先度：低

6. **追加機能**
   - ダークモード
   - 多言語対応（i18n）
   - プロジェクトのエクスポート機能（PDF/JSON）
   - 期間別統計（月別、年別）

## 参考リンク

- [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)
- [Next.js App Router Authentication](https://nextjs.org/docs/app/building-your-application/authentication)
- [Supabase Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)
- [Tailwind CSS Documentation](https://tailwindcss.com/docs)
