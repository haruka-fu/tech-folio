# DB 設計・API 設計（MVP版）

## 1. 前提

* データベース: Supabase PostgreSQL
* 認証: Supabase Auth（`auth.users`）
* アプリケーション側は `auth.uid()` を利用して `profile_id` と紐付ける
* 公開ページは実装しない（ユーザーダッシュボードのみ）

---

## 2. DB 設計

### 2.1 テーブル一覧

* `profiles`
* `auth_accounts`
* `tags`
* `projects`
* `project_tags`
* `profile_skill_stats`
* `qiita_tokens`

---

### 2.2 profiles テーブル

ユーザープロファイルを保持する。

```sql
create table public.profiles (
  id                  uuid primary key
                        references auth.users (id) on delete cascade,
  username            text not null unique,
  previous_username   text,
  username_changed_at timestamptz,

  display_name        text not null,
  avatar_url          text,
  bio                 text,
  job_title           text,

  sns_github_url      text,
  sns_qiita_url       text,
  sns_zenn_url        text,
  sns_other_url       text,

  visibility_flags    jsonb not null default '{}'::jsonb,

  created_at          timestamptz not null default now(),
  updated_at          timestamptz not null default now()
);
```

要件:

* `username` は英数字 4〜20 文字（API 側バリデーション）
* `username` は月 1 回のみ変更可能（API ロジックで制御）
* `sns_*_url` は `https://` のみ許可

---

### 2.3 auth_accounts テーブル

外部 OAuth プロバイダとユーザー ID の紐付け。

```sql
create table public.auth_accounts (
  id                  uuid primary key default gen_random_uuid(),
  profile_id          uuid not null
                        references public.profiles (id) on delete cascade,
  provider_name       text not null
                        check (provider_name in ('google', 'github', 'qiita')),
  provider_account_id text not null,
  email               text,
  created_at          timestamptz not null default now(),
  unique (provider_name, provider_account_id)
);
```

---

### 2.4 tags テーブル（技術タグ）

ユーザー専用の技術タグ。

```sql
create table public.tags (
  id              uuid primary key default gen_random_uuid(),
  profile_id      uuid not null
                    references public.profiles (id) on delete cascade,
  name            text not null,
  name_normalized text not null,
  created_at      timestamptz not null default now(),
  unique (profile_id, name_normalized)
);
```

要件:

* 1 ユーザー最大 10 タグ（API 側で制御）
* `name` は 20 文字以内
* 正規化処理を API 側で実施
  （小文字化、全角半角統一、trim）

---

### 2.5 projects テーブル（案件）

```sql
create table public.projects (
  id            uuid primary key default gen_random_uuid(),
  profile_id    uuid not null
                  references public.profiles (id) on delete cascade,

  title         text not null,
  summary       text,

  period_start  date not null,
  period_end    date,
  is_current    boolean not null default false,

  roles         text[] not null default '{}',

  description   text,
  created_at    timestamptz not null default now(),
  updated_at    timestamptz not null default now()
);
```

要件:

* `period_start` / `period_end` は `YYYY-MM-01` を格納
* `roles` は固定候補から複数選択
  （要件定義 / 基本設計 / 詳細設計 / 開発 / テスト / 運用 / 保守）
* `description` は 500 文字以内（API と DB 両方でチェック）

---

### 2.6 project_tags テーブル（案件×タグ）

```sql
create table public.project_tags (
  project_id uuid not null
               references public.projects (id) on delete cascade,
  tag_id     uuid not null
               references public.tags (id) on delete cascade,
  primary key (project_id, tag_id)
);
```

要件:

* 1 案件最大 10 タグ（API 側で制御）

---

### 2.7 profile_skill_stats テーブル（集計キャッシュ）

```sql
create table public.profile_skill_stats (
  profile_id  uuid not null
                references public.profiles (id) on delete cascade,
  tag_id      uuid not null
                references public.tags (id) on delete cascade,
  usage_count integer not null,
  updated_at  timestamptz not null default now(),
  primary key (profile_id, tag_id)
);
```

要件:

* 案件 CRUD 時に再集計
  （全削除 → 再計算 → insert）

---

### 2.8 qiita_tokens テーブル

```sql
create table public.qiita_tokens (
  profile_id             uuid primary key
                            references public.profiles (id) on delete cascade,
  encrypted_access_token text not null,
  encrypted_iv           text not null,
  expires_at             timestamptz not null,
  created_at             timestamptz not null default now(),
  updated_at             timestamptz not null default now()
);
```

要件:

* AES-256-GCM による暗号化結果を保存
* `expires_at` を過ぎたトークンは無効

---

## 3. RLS ポリシー概要

### 3.1 基本方針

全テーブルで RLS を有効化する。
CRUD は以下のルールに基づく。

* 自分の `profile_id = auth.uid()` のレコードのみ参照・更新可能
* `profiles` の `select` は必要に応じて制限
  （MVPでは “自分のプロフィールしか使わない” 前提なら `auth.uid() = id` のみでよい）

---

## 4. API 設計（Next.js Route Handlers）

### 4.1 プロフィール API

#### 4.1.1 GET `/api/profile`

現在のユーザープロフィールおよびスキル集計を取得する。

レスポンス例:

```json
{
  "profile": {
    "id": "uuid",
    "username": "haruka",
    "display_name": "深町 遥",
    "avatar_url": "https://...",
    "bio": "自己紹介文",
    "job_title": "Webエンジニア"
  },
  "skillStats": [
    {
      "tagId": "uuid",
      "tagName": "Next.js",
      "usageCount": 5
    }
  ],
  "tags": [
    { "id": "uuid", "name": "Next.js" }
  ]
}
```

---

#### 4.1.2 PUT `/api/profile`

プロフィール情報の更新。

リクエストボディ:

```json
{
  "display_name": "string",
  "bio": "string",
  "job_title": "string",
  "sns_github_url": "https://...",
  "sns_qiita_url": "https://...",
  "sns_zenn_url": "https://...",
  "sns_other_url": "https://...",
  "visibility_flags": {}
}
```

---

#### 4.1.3 PUT `/api/profile/username`

username の変更。

リクエストボディ:

```json
{
  "username": "newname"
}
```

要件:

* 英数字 4〜20 文字
* 月 1 回のみ変更可能
* 変更時に `previous_username`, `username_changed_at` を更新

---

#### 4.1.4 GET `/api/profile/check-username?value=xxx`

username の重複チェック。

レスポンス:

```json
{
  "available": true
}
```

---

### 4.2 タグ API

#### 4.2.1 GET `/api/tags`

ユーザー自身のタグ一覧を返す。

---

#### 4.2.2 GET `/api/tags/suggest?query=xxx`

タグ名の部分一致検索。
`name_normalized LIKE '{query_normalized}%'`

レスポンス例:

```json
{
  "tags": [
    { "id": "uuid", "name": "Next.js" }
  ]
}
```

---

### 4.3 Projects API

#### 4.3.1 GET `/api/projects`

案件一覧の取得。

クエリ:

* `page`
* `pageSize`
* `q`（title/summary）
* `tagId`
* `role`
* `sort`（`start_desc`/`title_asc`/`title_desc`/`tag_asc`）

---

#### 4.3.2 POST `/api/projects`

案件作成。

例:

```json
{
  "title": "予約管理システム",
  "summary": "Webシステム",
  "period_start": "2023-04",
  "period_end": "2024-03",
  "is_current": false,
  "roles": ["基本設計", "詳細設計", "開発"],
  "description": "説明",
  "tagNames": ["Next.js", "TypeScript"]
}
```

要件:

* タグ名正規化 → `tags` に upsert
  総数が 10 を超える場合はエラー
* 1 案件に 10 タグを超える場合はエラー
* 追加/編集後に `profile_skill_stats` を再計算

---

#### 4.3.3 GET `/api/projects/[id]`

案件詳細を取得。

---

#### 4.3.4 PUT `/api/projects/[id]`

案件更新。
POST と同じバリデーション。

---

#### 4.3.5 DELETE `/api/projects/[id]`

案件削除。
削除後、スキル集計を再計算。

---

### 4.4 Qiita API

#### 4.4.1 GET `/api/integrations/qiita/status`

Qiita 連携状態の取得。

---

#### 4.4.2 GET `/api/integrations/qiita/start`

Qiita OAuth 認可プロセスを開始。

---

#### 4.4.3 GET `/api/integrations/qiita/callback`

Qiita OAuth コールバック。

---

#### 4.4.4 GET `/api/qiita/articles`

Qiita 記事の一覧を取得（ユーザー専用）。

レスポンス例:

```json
{
  "items": [
    {
      "id": "qiita-item-id",
      "title": "記事タイトル",
      "url": "https://qiita.com/...",
      "likes_count": 10,
      "created_at": "2025-01-01T00:00:00+09:00"
    }
  ]
}
```
