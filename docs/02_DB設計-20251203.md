# Tech Folio データベース設計書

## テーブル作成順序

1. profiles
2. auth_providers
3. roles
4. tags
5. projects
6. project_tags

---

## 1. profiles テーブル

### 概要

ユーザーの基本情報とSNSリンクを管理

### テーブル定義

```sql
CREATE TABLE profiles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT NOT NULL UNIQUE
    CHECK (char_length(user_id) >= 4 AND char_length(user_id) <= 20),
  user_id_change_count INTEGER DEFAULT 0,
  display_name TEXT NOT NULL CHECK (display_name <> ''),
  email TEXT,
  bio TEXT,
  avatar_url TEXT CHECK (avatar_url IS NULL OR avatar_url ~ '^https?://'),
  github_url TEXT CHECK (github_url IS NULL OR github_url ~ '^https?://'),
  twitter_url TEXT CHECK (twitter_url IS NULL OR twitter_url ~ '^https?://'),
  qiita_url TEXT CHECK (qiita_url IS NULL OR qiita_url ~ '^https?://'),
  other_url TEXT CHECK (other_url IS NULL OR other_url ~ '^https?://'),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### カラム説明

| カラム名 | 型 | 制約 | 用途 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY | プロフィールの一意識別子 |
| user_id | TEXT | NOT NULL, UNIQUE, 4-20文字 | ユーザーID（何回でも変更可能、重複チェック付き） |
| user_id_change_count | INTEGER | DEFAULT 0 | user_id変更回数（変更履歴の記録用） |
| display_name | TEXT | NOT NULL, 空文字禁止 | 表示名 |
| email | TEXT | | メールアドレス（auth_providersから取得） |
| bio | TEXT | | 自己紹介文 |
| avatar_url | TEXT | URL形式 | プロフィール画像のURL |
| github_url | TEXT | URL形式 | GitHubプロフィールURL（手動入力） |
| twitter_url | TEXT | URL形式 | TwitterプロフィールURL（手動入力） |
| qiita_url | TEXT | URL形式 | QiitaプロフィールURL（手動入力） |
| other_url | TEXT | URL形式 | その他のURL（個人サイトなど） |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 最終更新日時 |

### 重要な仕様

- user_idは何回でも変更可能（重複チェック付き）
- user_id_change_countは変更履歴の記録用（制限なし）
- SNS URLは全て手動入力

---

## 2. auth_providers テーブル

### 概要

Google/GitHub/Qiitaでのログイン情報を管理

### テーブル定義

```sql
CREATE TABLE auth_providers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  profile_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  provider_type TEXT NOT NULL CHECK (provider_type IN ('google', 'github', 'qiita')),
  provider_user_id TEXT NOT NULL,
  provider_email TEXT,
  is_primary BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(provider_type, provider_user_id),
  UNIQUE(profile_id, provider_type)
);
```

### カラム説明

| カラム名 | 型 | 制約 | 用途 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY | 認証情報の一意識別子 |
| profile_id | UUID | FOREIGN KEY | どのプロフィールの認証情報か |
| provider_type | TEXT | NOT NULL, 列挙型 | 認証プロバイダーの種類（'google', 'github', 'qiita'） |
| provider_user_id | TEXT | NOT NULL | プロバイダー側のユーザーID |
| provider_email | TEXT | | プロバイダーから取得したメールアドレス |
| is_primary | BOOLEAN | DEFAULT false | プライマリー認証かどうか（最初に連携したもの） |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 連携開始日時 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 最終更新日時 |

### 重要な仕様

- トークンはDBに保存せず、セッションのみで管理（セキュリティ向上）
- 最初に連携したプロバイダーが `is_primary = true`
- プライマリーのメールアドレスを `profiles.email` に同期
- 1つのアカウントに対して最大3つの認証方法（Google, GitHub, Qiita）を紐付け可能

---

## 3. roles テーブル

### 概要

役割のマスターデータ（全ユーザー共通）

### テーブル定義

```sql
CREATE TABLE roles (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL UNIQUE CHECK (name <> ''),
  display_order INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### カラム説明

| カラム名 | 型 | 制約 | 用途 |
|---------|-----|------|------|
| id | SERIAL | PRIMARY KEY | 役割の一意識別子（1から始まる連番） |
| name | TEXT | NOT NULL, UNIQUE, 空文字禁止 | 役割名 |
| display_order | INTEGER | DEFAULT 0 | 表示順序の制御用 |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 最終更新日時 |

### 初期データ

```sql
INSERT INTO roles (name, display_order) VALUES
  ('要件定義', 1),
  ('基本設計', 2),
  ('詳細設計', 3),
  ('開発', 4),
  ('テスト', 5),
  ('運用', 6);
```

### 重要な仕様

- 全ユーザー共通のマスターデータ
- ユーザーカスタマイズ不可

---

## 4. tags テーブル

### 概要

技術タグの一元管理

### テーブル定義

```sql
CREATE TABLE tags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL UNIQUE CHECK (name <> ''),
  category TEXT,
  color TEXT CHECK (color IS NULL OR color ~ '^#[0-9A-Fa-f]{6}$'),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### カラム説明

| カラム名 | 型 | 制約 | 用途 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY | タグの一意識別子 |
| name | TEXT | NOT NULL, UNIQUE, 空文字禁止 | タグ名（例: "React", "TypeScript"） |
| category | TEXT | | カテゴリ分類（例: "Frontend", "Backend", "DevOps"） |
| color | TEXT | 16進数カラーコード形式 | タグの表示色（例: "#2b6cee"） |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 最終更新日時 |

### 重要な仕様

- 設定画面で追加・編集・削除可能

---

## 5. projects テーブル

### 概要

プロジェクト一覧ページで表示されるプロジェクト情報の管理

### テーブル定義

```sql
CREATE TABLE projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  profile_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  title TEXT NOT NULL CHECK (title <> ''),
  summary TEXT NOT NULL CHECK (summary <> ''),
  description TEXT NOT NULL CHECK (description <> ''),
  period_start DATE NOT NULL,
  period_end DATE CHECK (period_end IS NULL OR period_end >= period_start),
  is_current BOOLEAN DEFAULT false,
  roles INTEGER[],
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### カラム説明

| カラム名 | 型 | 制約 | 用途 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY | プロジェクトの一意識別子 |
| profile_id | UUID | FOREIGN KEY | どのプロフィールのプロジェクトか |
| title | TEXT | NOT NULL, 空文字禁止 | プロジェクトタイトル |
| summary | TEXT | NOT NULL, 空文字禁止 | プロジェクト概要 |
| description | TEXT | NOT NULL, 空文字禁止 | プロジェクト詳細説明 |
| period_start | DATE | NOT NULL | プロジェクト開始日 |
| period_end | DATE | 開始日以降の制約 | プロジェクト終了日（NULL=進行中） |
| is_current | BOOLEAN | DEFAULT false | 現在進行中かどうか |
| roles | INTEGER[] | | 担当役割IDの配列（rolesテーブル参照） |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | 最終更新日時 |

### 重要な仕様

- TOONファイルの[[project]]セクションに対応
- rolesは配列で管理（順序は無意味）

---

## 6. project_tags テーブル

### 概要

プロジェクトとタグの多対多関連

### テーブル定義

```sql
CREATE TABLE project_tags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  tag_id UUID REFERENCES tags(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(project_id, tag_id)
);
```

### カラム説明

| カラム名 | 型 | 制約 | 用途 |
|---------|-----|------|------|
| id | UUID | PRIMARY KEY | 関連レコードの一意識別子 |
| project_id | UUID | FOREIGN KEY | プロジェクトID |
| tag_id | UUID | FOREIGN KEY | タグID |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | 関連付けた日時 |

### 重要な仕様

- フィルタリング機能、スキル統計の集計に使用

---

## インデックス定義

```sql
-- auth_providers
CREATE INDEX idx_auth_providers_profile_id ON auth_providers(profile_id);
CREATE INDEX idx_auth_providers_type ON auth_providers(provider_type);
CREATE INDEX idx_auth_providers_primary ON auth_providers(is_primary) WHERE is_primary = true;

-- projects
CREATE INDEX idx_projects_profile_id ON projects(profile_id);
CREATE INDEX idx_projects_is_current ON projects(is_current);
CREATE INDEX idx_projects_period ON projects(period_start, period_end);

-- project_tags
CREATE INDEX idx_project_tags_project_id ON project_tags(project_id);
CREATE INDEX idx_project_tags_tag_id ON project_tags(tag_id);

-- tags
CREATE INDEX idx_tags_name ON tags(name);

-- roles
CREATE INDEX idx_roles_name ON roles(name);
```

---

## トリガー定義

### updated_at自動更新トリガー

```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_profiles_updated_at BEFORE UPDATE ON profiles
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_auth_providers_updated_at BEFORE UPDATE ON auth_providers
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_roles_updated_at BEFORE UPDATE ON roles
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_tags_updated_at BEFORE UPDATE ON tags
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_projects_updated_at BEFORE UPDATE ON projects
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

---

## データの関係性

```
profiles (1) ──→ (多) auth_providers
  ├─ 最初に連携したものが is_primary = true
  └─ プライマリーのメールアドレスを profiles.email に同期

profiles (1) ──→ (多) projects

projects (多) ←→ (多) tags
  └─ project_tags で多対多関連

projects (多) ──→ (多) roles
  └─ roles カラム（INTEGER配列）で参照
```

---

## 重要な設計方針

1. **user_id変更**: 何回でも変更可能、重複チェック付き
2. **トークン管理**: DBに保存せず、セッションのみで管理（セキュリティ向上）
3. **プライマリー認証**: 最初に連携した認証プロバイダーが自動的にプライマリー
4. **削除方式**: 論理削除ではなく物理削除
5. **スキル統計**: project_tagsテーブルから集計
6. **制約**: データ整合性を保証するため、各テーブルにCHECK制約を設定
